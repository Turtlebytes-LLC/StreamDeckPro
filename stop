#!/bin/bash
#
# Stop Stream Deck Daemon and clean up monitor processes
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "Stopping Stream Deck daemon..."

# Stop the daemon
if pgrep -f "streamdeck-daemon.py" > /dev/null; then
    pkill -f "streamdeck-daemon.py"
    echo "Daemon stopped"
else
    echo "Daemon is not running"
fi

# Clean up any running monitor processes
echo "Checking for running monitor processes..."
MONITOR_PIDS=$(pgrep -f "monitor.*\.sh|touch-[0-9]\.sh" 2>/dev/null)
if [ -n "$MONITOR_PIDS" ]; then
    echo "Found running monitor processes, cleaning up..."
    pkill -9 -f "monitor.*\.sh" 2>/dev/null
    pkill -9 -f "touch-[0-9]\.sh" 2>/dev/null
    sleep 0.3
    echo "Monitor processes terminated"
else
    echo "No monitor processes running"
fi

# Clean up temporary files
echo "Cleaning up temporary files..."
rm -f /tmp/streamdeck-*-monitor-*.pid 2>/dev/null
rm -f /tmp/streamdeck-*-chart-*.pid 2>/dev/null
rm -f /tmp/streamdeck-*-chart-data-*.txt 2>/dev/null
rm -f /tmp/cpu_chart*.png 2>/dev/null
echo "Cleanup complete"
